name: Conflict Fixer

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  conflict-fixer:
    if: >-
      contains(fromJson('["jeong-sik/masc-mcp","jeong-sik/figma-mcp","jeong-sik/llm-mcp"]'), github.repository)
      && github.event.pull_request.draft == false
      && github.event.pull_request.base.ref == github.event.repository.default_branch
      && github.event.pull_request.user.login == 'jeong-sik'
      && github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    steps:
      - name: Read merge state
        id: state
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail
          state="$(gh pr view "$PR_NUMBER" --repo "$REPO" --json mergeStateStatus --jq '.mergeStateStatus // "UNKNOWN"')"
          echo "merge_state=$state" >> "$GITHUB_OUTPUT"

      - name: Update branch when behind
        if: steps.state.outputs.merge_state == 'BEHIND'
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail
          gh api -X PUT "repos/$REPO/pulls/$PR_NUMBER/update-branch"

      - name: Comment branch update
        if: steps.state.outputs.merge_state == 'BEHIND'
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail
          marker='[CONFLICT-FIXER]'
          existing="$(gh api "repos/$REPO/issues/$PR_NUMBER/comments" --paginate --jq ".[] | select(.user.login == \"github-actions[bot]\" and (.body | contains(\"$marker\")) and (.body | contains(\"update-branch\"))) | .id" | head -n1 || true)"
          if [ -n "$existing" ]; then
            exit 0
          fi

          gh api "repos/$REPO/issues/$PR_NUMBER/comments" \
            -f body="$marker base 브랜치 대비 뒤처져 있어 update-branch를 실행했습니다."

      - name: Comment manual conflict resolution guide
        if: steps.state.outputs.merge_state == 'DIRTY'
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail
          marker='[CONFLICT-FIXER]'
          existing="$(gh api "repos/$REPO/issues/$PR_NUMBER/comments" --paginate --jq ".[] | select(.user.login == \"github-actions[bot]\" and (.body | contains(\"$marker\")) and (.body | contains(\"충돌\"))) | .id" | head -n1 || true)"
          if [ -n "$existing" ]; then
            exit 0
          fi

          gh api "repos/$REPO/issues/$PR_NUMBER/comments" \
            -f body="$marker 현재 PR은 충돌 상태(DIRTY)입니다. 로컬에서 base 브랜치를 rebase/merge 후 push 해주세요."
