{
  "id": "pr-review-pipeline",
  "name": "PR Review Pipeline",
  "description": "Automated PR review: diff analysis, test coverage check, security scan, documentation check",
  "version": "1.0.0",
  "nodes": [
    {
      "id": "fetch-pr-diff",
      "type": "tool",
      "tool": {
        "server": "github",
        "name": "get_pull_request_diff",
        "args": { "repo": "{{input.repo}}", "pr_number": "{{input.pr_number}}" }
      },
      "output_key": "pr_diff"
    },
    {
      "id": "fetch-pr-files",
      "type": "tool",
      "tool": {
        "server": "github",
        "name": "get_pull_request_files",
        "args": { "repo": "{{input.repo}}", "pr_number": "{{input.pr_number}}" }
      },
      "output_key": "changed_files"
    },
    {
      "id": "analyze-complexity",
      "type": "llm",
      "llm": {
        "model": "gemini",
        "prompt": "Analyze the complexity of this PR diff. Consider:\n1. Lines of code changed\n2. Number of files affected\n3. Cyclomatic complexity increase\n4. Coupling/cohesion impact\n\nDiff:\n```\n{{pr_diff}}\n```\n\nFiles changed:\n{{changed_files}}\n\nOutput JSON: {\"complexity_score\": 1-10, \"risk_areas\": [...], \"summary\": \"...\"}"
      },
      "depends_on": ["fetch-pr-diff", "fetch-pr-files"],
      "output_key": "complexity_analysis"
    },
    {
      "id": "check-test-coverage",
      "type": "llm",
      "llm": {
        "model": "claude-cli",
        "prompt": "Review test coverage for this PR.\n\nChanged files:\n{{changed_files}}\n\nDiff:\n```\n{{pr_diff}}\n```\n\nIdentify:\n1. New code paths that need tests\n2. Existing tests that might be affected\n3. Edge cases not covered\n\nOutput JSON: {\"coverage_gaps\": [...], \"suggested_tests\": [...], \"score\": 1-10}"
      },
      "depends_on": ["fetch-pr-diff", "fetch-pr-files"],
      "output_key": "test_coverage"
    },
    {
      "id": "security-scan",
      "type": "llm",
      "llm": {
        "model": "codex",
        "prompt": "Security review for PR changes.\n\nDiff:\n```\n{{pr_diff}}\n```\n\nCheck for:\n1. SQL injection vulnerabilities\n2. XSS vectors\n3. Authentication/authorization issues\n4. Sensitive data exposure\n5. Dependency vulnerabilities\n6. Input validation gaps\n\nOutput JSON: {\"vulnerabilities\": [{\"severity\": \"critical|high|medium|low\", \"type\": \"...\", \"location\": \"...\", \"fix\": \"...\"}], \"safe\": true|false}"
      },
      "depends_on": ["fetch-pr-diff"],
      "output_key": "security_findings"
    },
    {
      "id": "doc-check",
      "type": "llm",
      "llm": {
        "model": "gemini",
        "prompt": "Check documentation completeness for this PR.\n\nChanged files:\n{{changed_files}}\n\nDiff:\n```\n{{pr_diff}}\n```\n\nVerify:\n1. New public APIs have JSDoc/docstrings\n2. README updates if needed\n3. CHANGELOG entry required?\n4. Breaking changes documented?\n\nOutput JSON: {\"doc_issues\": [...], \"suggestions\": [...], \"changelog_needed\": true|false}"
      },
      "depends_on": ["fetch-pr-diff", "fetch-pr-files"],
      "output_key": "doc_review"
    },
    {
      "id": "synthesize-review",
      "type": "llm",
      "llm": {
        "model": "claude-cli",
        "prompt": "Synthesize a comprehensive PR review from these analyses:\n\nComplexity Analysis:\n{{complexity_analysis}}\n\nTest Coverage:\n{{test_coverage}}\n\nSecurity Findings:\n{{security_findings}}\n\nDocumentation Review:\n{{doc_review}}\n\nGenerate a PR review comment in markdown with:\n1. **Summary** (1-2 sentences)\n2. **Verdict** (APPROVE / REQUEST_CHANGES / COMMENT)\n3. **Critical Issues** (must fix before merge)\n4. **Suggestions** (nice to have)\n5. **Kudos** (things done well)\n\nBe constructive and specific."
      },
      "depends_on": ["analyze-complexity", "check-test-coverage", "security-scan", "doc-check"],
      "output_key": "final_review"
    }
  ],
  "input_schema": {
    "type": "object",
    "properties": {
      "repo": {
        "type": "string",
        "description": "Repository in format owner/repo"
      },
      "pr_number": {
        "type": "integer",
        "description": "Pull request number"
      }
    },
    "required": ["repo", "pr_number"]
  },
  "metadata": {
    "author": "Chain Engine",
    "tags": ["github", "pr-review", "ci-cd", "automation"],
    "estimated_duration_sec": 90,
    "estimated_cost_usd": 0.12
  }
}
