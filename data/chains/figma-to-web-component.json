{
  "id": "figma-to-web-component",
  "name": "Figma to Web Component (Vision-First)",
  "description": "Vision-First 아키텍처로 Figma 디자인에서 웹 컴포넌트(React+Tailwind) 생성. SSIM 0.95+ 엄격 검증.",
  "version": "1.0.0",
  "nodes": [
    {
      "id": "parse-url",
      "type": "tool",
      "tool": {
        "server": "figma",
        "name": "figma_parse_url",
        "args": { "url": "{{input.figma_url}}" }
      },
      "output_key": "figma_meta"
    },
    {
      "id": "export-figma-image",
      "type": "tool",
      "tool": {
        "server": "figma",
        "name": "figma_export_image",
        "args": {
          "file_key": "{{figma_meta.file_key}}",
          "node_ids": "{{figma_meta.node_id}}",
          "token": "env:FIGMA_TOKEN",
          "scale": 2,
          "format": "png"
        }
      },
      "depends_on": ["parse-url"],
      "output_key": "figma_image"
    },
    {
      "id": "get-design-structure",
      "type": "tool",
      "tool": {
        "server": "figma",
        "name": "figma_get_node_summary",
        "args": {
          "file_key": "{{figma_meta.file_key}}",
          "node_id": "{{figma_meta.node_id}}",
          "token": "env:FIGMA_TOKEN"
        }
      },
      "depends_on": ["parse-url"],
      "output_key": "design_summary"
    },
    {
      "id": "extract-dsl",
      "type": "tool",
      "tool": {
        "server": "figma",
        "name": "figma_get_node_bundle",
        "args": {
          "file_key": "{{figma_meta.file_key}}",
          "node_id": "{{figma_meta.node_id}}",
          "token": "env:FIGMA_TOKEN",
          "depth": 4,
          "include_variables": true,
          "include_image_fills": true
        }
      },
      "depends_on": ["parse-url"],
      "output_key": "figma_dsl"
    },
    {
      "id": "vision-analyze",
      "type": "llm",
      "llm": {
        "model": "claude-cli",
        "prompt": "이 Figma 디자인을 분석하세요.\n\nFigma DSL:\n{{figma_dsl}}\n\n구조 요약:\n{{design_summary}}\n\n다음 정보를 추출하세요:\n\n1. **컴포넌트 타입**: 버튼, 카드, 리스트, 폼, 네비게이션 등\n2. **레이아웃 구조**: Flexbox/Grid 패턴, 방향, 정렬\n3. **디자인 토큰**: 색상 (#hex), 간격 (px), 폰트 크기/굵기, border-radius\n4. **텍스트 내용**: DSL의 characters 필드 그대로 (번역/수정 금지)\n5. **인터랙션 힌트**: 버튼 hover, 입력 focus 등\n\nJSON 형식으로 출력:\n{\n  \"component_type\": \"string\",\n  \"layout\": { \"direction\": \"row|column\", \"align\": \"...\", \"justify\": \"...\" },\n  \"tokens\": { \"colors\": [...], \"spacing\": [...], \"typography\": {...} },\n  \"texts\": [...],\n  \"suggested_name\": \"PascalCase\"\n}"
      },
      "depends_on": ["extract-dsl", "get-design-structure"],
      "output_key": "vision_analysis"
    },
    {
      "id": "component-gate",
      "type": "llm",
      "llm": {
        "model": "gemini",
        "prompt": "이 분석 결과가 구현할 만한 컴포넌트인지 판단하세요.\n\n분석:\n{{vision_analysis}}\n\nDSL 구조:\n{{design_summary}}\n\n**판단 기준:**\n- ✅ 구현해야 함: 2개 이상 자식 노드, 의미 있는 UI (버튼, 카드, 폼 등)\n- ❌ 스킵: 빈 Frame, 자식 1개인 wrapper, 순수 장식\n\n**출력 (JSON):**\n{\n  \"implementable\": true/false,\n  \"reason\": \"구현/스킵 이유\",\n  \"component_type\": \"card|button|list|form|nav|...\",\n  \"complexity\": \"simple|medium|complex\",\n  \"suggested_name\": \"ComponentName\"\n}"
      },
      "depends_on": ["vision-analyze", "get-design-structure"],
      "output_key": "gate_result"
    },
    {
      "id": "generate-react-code",
      "type": "llm",
      "llm": {
        "model": "claude-cli",
        "prompt": "React + Tailwind 컴포넌트를 생성하세요.\n\n## 디자인 분석\n{{vision_analysis}}\n\n## 게이트 결과\n{{gate_result}}\n\n## 상세 DSL\n{{figma_dsl}}\n\n## 요구사항\n1. TypeScript + React.FC\n2. Tailwind CSS만 사용 (inline style 금지)\n3. DSL의 characters 텍스트 그대로 사용 (번역 금지)\n4. 정확한 색상값 사용: #RRGGBB → bg-[#RRGGBB]\n5. 정확한 크기: width × height → w-[320px] h-[200px]\n6. border-radius: r:8 → rounded-lg 또는 rounded-[8px]\n7. 간격: gap:12 → gap-3, padding:16 → p-4\n\n## 출력 형식\n코드만 출력 (설명 없이):\n```tsx\n// 컴포넌트 코드\n```"
      },
      "depends_on": ["vision-analyze", "component-gate", "extract-dsl"],
      "condition": "{{gate_result.implementable}} == true",
      "output_key": "react_code"
    },
    {
      "id": "verify-visual",
      "type": "tool",
      "tool": {
        "server": "figma",
        "name": "figma_verify_visual",
        "args": {
          "file_key": "{{figma_meta.file_key}}",
          "node_id": "{{figma_meta.node_id}}",
          "token": "env:FIGMA_TOKEN",
          "html": "{{react_code}}",
          "target_ssim": 0.95,
          "max_iterations": 5
        }
      },
      "depends_on": ["generate-react-code", "parse-url"],
      "output_key": "verification"
    },
    {
      "id": "importance-check",
      "type": "llm",
      "llm": {
        "model": "gemini",
        "prompt": "시각적 검증 결과를 분석하세요.\n\n## 검증 결과\n{{verification}}\n\n## 디자인 분석\n{{vision_analysis}}\n\n**중요도 판단 기준:**\n1. 차이 영역이 전체의 몇 %인가?\n2. 기능적 요소(버튼, 입력창)인가 vs 장식적 요소(그림자, 테두리)인가?\n3. 사용자가 바로 인지하는 영역인가?\n\n**출력 (JSON):**\n{\n  \"overall_passed\": true/false,\n  \"ssim_score\": 0.0-1.0,\n  \"text_accuracy\": 0.0-1.0,\n  \"importance\": \"low|medium|high\",\n  \"remaining_differences\": [\"차이점1\", \"차이점2\"],\n  \"recommendation\": \"pass|retry|human_review\",\n  \"rationale\": \"판단 근거\"\n}"
      },
      "depends_on": ["verify-visual", "vision-analyze"],
      "output_key": "importance_result"
    },
    {
      "id": "final-output",
      "type": "llm",
      "llm": {
        "model": "gemini",
        "prompt": "최종 결과를 정리하세요.\n\n## 컴포넌트 정보\n- 타입: {{gate_result.component_type}}\n- 이름: {{gate_result.suggested_name}}\n\n## 생성된 코드\n{{react_code}}\n\n## 검증 결과\n{{verification}}\n\n## 중요도 분석\n{{importance_result}}\n\n## 출력 형식 (Markdown)\n### {{gate_result.suggested_name}}\n\n**검증 결과:** SSIM {{importance_result.ssim_score}}, 텍스트 정확도 {{importance_result.text_accuracy}}\n\n**상태:** {{importance_result.recommendation}}\n\n**코드:**\n```tsx\n// 코드 삽입\n```\n\n**남은 차이점:**\n- (있으면 목록)\n\n**권장 조치:**\n- (있으면 목록)"
      },
      "depends_on": ["generate-react-code", "verify-visual", "importance-check", "component-gate"],
      "output_key": "final_report"
    }
  ],
  "output": "final-output",
  "input_schema": {
    "type": "object",
    "properties": {
      "figma_url": {
        "type": "string",
        "description": "Figma frame/component URL (예: https://www.figma.com/file/xxx/Design?node-id=1-2)"
      },
      "target_ssim": {
        "type": "number",
        "default": 0.95,
        "description": "목표 SSIM 점수 (0-1, 기본값: 0.95)"
      },
      "max_iterations": {
        "type": "integer",
        "default": 5,
        "description": "최대 반복 횟수 (기본값: 5)"
      }
    },
    "required": ["figma_url"]
  },
  "output_schema": {
    "type": "object",
    "properties": {
      "final_report": { "type": "string" },
      "react_code": { "type": "string" },
      "verification": { "type": "object" },
      "importance_result": { "type": "object" }
    }
  },
  "metadata": {
    "author": "Vision-First Chain Engine",
    "tags": ["figma", "react", "tailwind", "vision", "ssim", "component"],
    "estimated_duration_sec": 120,
    "estimated_cost_usd": 0.25
  }
}
