{
  "id": "incident-response",
  "name": "Incident Response Pipeline",
  "description": "Automated incident triage: log analysis, root cause hypothesis, runbook matching, communication draft",
  "version": "1.0.0",
  "nodes": [
    {
      "id": "parse-alert",
      "type": "llm",
      "llm": {
        "model": "gemini",
        "prompt": "Parse this incident alert and extract structured information:\n\nAlert:\n{{input.alert_text}}\n\nExtract JSON: {\"service\": \"...\", \"severity\": \"P1|P2|P3|P4\", \"error_type\": \"...\", \"affected_users\": \"...\", \"timestamp\": \"...\", \"metrics\": {...}}"
      },
      "output_key": "parsed_alert"
    },
    {
      "id": "fetch-recent-logs",
      "type": "tool",
      "tool": {
        "server": "observability",
        "name": "query_logs",
        "args": {
          "service": "{{parsed_alert.service}}",
          "time_range": "30m",
          "level": "error"
        }
      },
      "depends_on": ["parse-alert"],
      "output_key": "error_logs"
    },
    {
      "id": "fetch-metrics",
      "type": "tool",
      "tool": {
        "server": "observability",
        "name": "query_metrics",
        "args": {
          "service": "{{parsed_alert.service}}",
          "metrics": ["latency_p99", "error_rate", "request_count"],
          "time_range": "1h"
        }
      },
      "depends_on": ["parse-alert"],
      "output_key": "service_metrics"
    },
    {
      "id": "fetch-recent-deploys",
      "type": "tool",
      "tool": {
        "server": "deployment",
        "name": "list_deployments",
        "args": {
          "service": "{{parsed_alert.service}}",
          "time_range": "24h"
        }
      },
      "depends_on": ["parse-alert"],
      "output_key": "recent_deploys"
    },
    {
      "id": "analyze-logs",
      "type": "llm",
      "llm": {
        "model": "codex",
        "prompt": "Analyze these error logs to identify patterns and root cause:\n\nService: {{parsed_alert.service}}\nError Logs:\n{{error_logs}}\n\nLook for:\n1. Error patterns (repeated exceptions, stack traces)\n2. Correlation with timestamps\n3. Affected components/endpoints\n4. Dependency failures\n\nOutput JSON: {\"error_patterns\": [...], \"likely_component\": \"...\", \"confidence\": 0.0-1.0}"
      },
      "depends_on": ["fetch-recent-logs", "parse-alert"],
      "output_key": "log_analysis"
    },
    {
      "id": "correlate-deploys",
      "type": "llm",
      "llm": {
        "model": "gemini",
        "prompt": "Correlate incident timing with recent deployments:\n\nAlert timestamp: {{parsed_alert.timestamp}}\nRecent deployments:\n{{recent_deploys}}\n\nDetermine if any deployment could have caused this incident.\n\nOutput JSON: {\"deployment_correlated\": true|false, \"suspect_deploy\": {...}|null, \"time_delta_minutes\": N, \"rollback_recommended\": true|false}"
      },
      "depends_on": ["parse-alert", "fetch-recent-deploys"],
      "output_key": "deploy_correlation"
    },
    {
      "id": "generate-hypothesis",
      "type": "llm",
      "llm": {
        "model": "claude-cli",
        "prompt": "Generate root cause hypotheses for this incident:\n\nParsed Alert:\n{{parsed_alert}}\n\nLog Analysis:\n{{log_analysis}}\n\nMetrics:\n{{service_metrics}}\n\nDeployment Correlation:\n{{deploy_correlation}}\n\nRank top 3 hypotheses by likelihood:\n\nOutput JSON: {\"hypotheses\": [{\"description\": \"...\", \"likelihood\": 0.0-1.0, \"evidence\": [...], \"mitigation\": \"...\"}]}"
      },
      "depends_on": ["parse-alert", "analyze-logs", "fetch-metrics", "correlate-deploys"],
      "output_key": "root_cause_hypotheses"
    },
    {
      "id": "match-runbook",
      "type": "tool",
      "tool": {
        "server": "knowledge-base",
        "name": "semantic_search",
        "args": {
          "query": "{{parsed_alert.service}} {{parsed_alert.error_type}} incident runbook",
          "collection": "runbooks",
          "limit": 3
        }
      },
      "depends_on": ["parse-alert"],
      "output_key": "matched_runbooks"
    },
    {
      "id": "draft-communication",
      "type": "llm",
      "llm": {
        "model": "gemini",
        "prompt": "Draft incident communication based on:\n\nSeverity: {{parsed_alert.severity}}\nService: {{parsed_alert.service}}\nRoot Cause Hypotheses:\n{{root_cause_hypotheses}}\n\nGenerate:\n1. Slack message for #incidents channel\n2. Status page update (if P1/P2)\n3. Customer communication template (if needed)\n\nOutput markdown with all 3 sections."
      },
      "depends_on": ["parsed_alert", "root_cause_hypotheses"],
      "output_key": "communications"
    },
    {
      "id": "assemble-response",
      "type": "llm",
      "llm": {
        "model": "claude-cli",
        "prompt": "Assemble the complete incident response package:\n\n## Alert Summary\n{{parsed_alert}}\n\n## Root Cause Analysis\n{{root_cause_hypotheses}}\n\n## Recommended Actions\nBased on runbooks:\n{{matched_runbooks}}\n\n## Communications\n{{communications}}\n\nFormat as a structured incident response document with:\n1. **TL;DR** (2 sentences)\n2. **Immediate Actions** (numbered steps)\n3. **Investigation Findings**\n4. **Communication Templates**\n5. **Follow-up Tasks**"
      },
      "depends_on": ["root_cause_hypotheses", "match-runbook", "draft-communication"],
      "output_key": "incident_response"
    }
  ],
  "input_schema": {
    "type": "object",
    "properties": {
      "alert_text": {
        "type": "string",
        "description": "Raw alert text from monitoring system (PagerDuty, Datadog, etc.)"
      }
    },
    "required": ["alert_text"]
  },
  "metadata": {
    "author": "Chain Engine",
    "tags": ["incident", "oncall", "sre", "automation"],
    "estimated_duration_sec": 120,
    "estimated_cost_usd": 0.18
  }
}
