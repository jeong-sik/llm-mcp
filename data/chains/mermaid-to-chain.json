{
  "id": "mermaid-to-chain",
  "name": "Mermaid to Chain Converter",
  "description": "Convert Mermaid graph diagrams to executable Chain JSON definitions",
  "version": "1.0.0",
  "nodes": [
    {
      "id": "parse-mermaid",
      "type": "llm",
      "llm": {
        "model": "codex",
        "prompt": "Parse this Mermaid diagram and extract the graph structure:\n\n```mermaid\n{{input.mermaid}}\n```\n\nExtract:\n1. All nodes with their IDs and labels\n2. All edges (dependencies) between nodes\n3. Node types from labels (look for hints like üî¨=codex, üë©=claude, üéØ=gemini, üîç=tool)\n4. Any metadata in brackets or annotations\n\nOutput JSON:\n```json\n{\n  \"nodes\": [{\"id\": \"...\", \"label\": \"...\", \"type\": \"llm|tool\", \"model\": \"...\", \"metadata\": {...}}],\n  \"edges\": [{\"from\": \"...\", \"to\": \"...\"}],\n  \"direction\": \"TD|LR\"\n}\n```"
      },
      "output_key": "parsed_graph"
    },
    {
      "id": "infer-node-types",
      "type": "llm",
      "llm": {
        "model": "gemini",
        "prompt": "Analyze these parsed nodes and infer their chain node types:\n\nParsed Graph:\n{{parsed_graph}}\n\nFor each node, determine:\n1. Is it an LLM node or Tool node?\n2. If LLM: which model? (codex for code/bugs, claude for quality/clarity, gemini for strategy/synthesis)\n3. If Tool: what server and tool name?\n4. What should the prompt/args be based on the label?\n\nOutput JSON with enriched nodes:\n```json\n{\n  \"nodes\": [{\n    \"id\": \"...\",\n    \"type\": \"llm|tool\",\n    \"config\": {\n      \"model\": \"codex|claude|gemini\",\n      \"prompt\": \"...\"\n    } | {\n      \"server\": \"...\",\n      \"name\": \"...\",\n      \"args\": {...}\n    }\n  }]\n}\n```"
      },
      "depends_on": ["parse-mermaid"],
      "output_key": "enriched_nodes"
    },
    {
      "id": "build-dependencies",
      "type": "llm",
      "llm": {
        "model": "gemini",
        "prompt": "Build the dependency graph from edges:\n\nParsed Graph:\n{{parsed_graph}}\n\nFor each node, list its dependencies (nodes it depends on based on incoming edges).\n\nOutput JSON:\n```json\n{\n  \"dependencies\": {\n    \"node_id\": [\"dep1\", \"dep2\"],\n    ...\n  },\n  \"execution_order\": [\"first\", \"second\", ...],\n  \"parallel_groups\": [[\"can_run_together\"], ...]\n}\n```"
      },
      "depends_on": ["parse-mermaid"],
      "output_key": "dependency_graph"
    },
    {
      "id": "generate-chain-json",
      "type": "llm",
      "llm": {
        "model": "claude-cli",
        "prompt": "Generate the final Chain JSON from the analyzed components:\n\nEnriched Nodes:\n{{enriched_nodes}}\n\nDependency Graph:\n{{dependency_graph}}\n\nOriginal Mermaid:\n```mermaid\n{{input.mermaid}}\n```\n\nGenerate a valid Chain JSON following this schema:\n```json\n{\n  \"id\": \"generated-chain\",\n  \"name\": \"...\",\n  \"description\": \"Generated from Mermaid diagram\",\n  \"version\": \"1.0.0\",\n  \"nodes\": [\n    {\n      \"id\": \"node-id\",\n      \"type\": \"llm|tool\",\n      \"llm\": { \"model\": \"...\", \"prompt\": \"...\" },\n      \"tool\": { \"server\": \"...\", \"name\": \"...\", \"args\": {...} },\n      \"depends_on\": [\"dep1\", \"dep2\"],\n      \"output_key\": \"result_name\"\n    }\n  ],\n  \"input_schema\": {...},\n  \"metadata\": {...}\n}\n```\n\nRules:\n1. Each node needs output_key matching its id (snake_case)\n2. depends_on should reference node IDs from the graph\n3. LLM prompts should use {{previous_output}} for dependencies\n4. Infer reasonable input_schema from the diagram\n\nOutput ONLY the JSON, no explanation."
      },
      "depends_on": ["enriched_nodes", "dependency_graph"],
      "output_key": "chain_json"
    },
    {
      "id": "validate-chain",
      "type": "llm",
      "llm": {
        "model": "codex",
        "prompt": "Validate this generated Chain JSON:\n\n```json\n{{chain_json}}\n```\n\nCheck:\n1. All node IDs are unique\n2. All depends_on references exist\n3. No circular dependencies\n4. All required fields present\n5. JSON is syntactically valid\n\nOutput JSON:\n```json\n{\n  \"valid\": true|false,\n  \"errors\": [...],\n  \"warnings\": [...],\n  \"fixed_json\": <corrected JSON if needed>\n}\n```"
      },
      "depends_on": ["generate-chain-json"],
      "output_key": "validation"
    },
    {
      "id": "final-output",
      "type": "llm",
      "llm": {
        "model": "gemini",
        "prompt": "Prepare the final output:\n\nValidation Result:\n{{validation}}\n\nOriginal Generated:\n{{chain_json}}\n\nIf validation passed, output the chain JSON.\nIf validation failed but was fixed, output the fixed JSON.\nIf unfixable errors, explain the issues.\n\nOutput format:\n```json\n<the final chain JSON>\n```\n\nFollowed by a brief summary of the conversion."
      },
      "depends_on": ["validation", "generate-chain-json"],
      "output_key": "final_chain"
    }
  ],
  "input_schema": {
    "type": "object",
    "properties": {
      "mermaid": {
        "type": "string",
        "description": "Mermaid graph diagram (graph TD/LR format)"
      }
    },
    "required": ["mermaid"]
  },
  "metadata": {
    "author": "Chain Engine",
    "tags": ["mermaid", "converter", "visual-programming", "no-code"],
    "estimated_duration_sec": 60,
    "estimated_cost_usd": 0.10
  }
}
