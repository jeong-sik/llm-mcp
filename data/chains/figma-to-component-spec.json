{
  "id": "figma-to-component-spec",
  "name": "Figma → Component Spec (JSON)",
  "description": "Figma summary를 기반으로 컴포넌트 스펙(JSON)을 생성합니다. 실패 시 fallback JSON을 반환합니다.",
  "version": "1.0.0",
  "nodes": [
    {
      "id": "flow",
      "type": "pipeline",
      "nodes": [
        {
          "id": "summary",
          "type": "tool",
          "tool": {
            "name": "figma.figma_get_node_summary",
            "args": {
              "url": "{{input.url}}",
              "max_children": 10
            }
          }
        },
        {
          "id": "summary-json",
          "type": "adapter",
          "input_ref": "summary",
          "transform": {
            "type": "parse_json"
          },
          "on_error": "fail"
        },
        {
          "id": "safe",
          "type": "fallback",
          "primary": {
            "id": "build",
            "type": "retry",
            "max_attempts": 1,
            "backoff": "constant:0.7",
            "retry_on": [
              "Schema validation failed",
              "No JSON object/array found",
              "Not valid JSON",
              "Invalid JSON",
              "Timeout"
            ],
            "node": {
              "id": "primary-flow",
              "type": "pipeline",
              "nodes": [
                {
                  "id": "spec-gemini-llm",
                  "type": "tool",
                  "tool": {
                    "name": "gemini",
                    "args": {
                      "model": "gemini-3-pro-preview",
                      "thinking_level": "high",
                      "timeout": 60,
                      "stream": false,
                      "prompt": "Return ONLY valid JSON.\n\nSUMMARY(JSON):\n{{summary-json}}\n\nOUTPUT JSON (exact keys):\n{\n  \"component_name\": string,\n  \"component_type\": string,\n  \"layout\": { \"type\": string, \"notes\": string },\n  \"tokens\": { \"colors\": [string], \"spacing\": [string], \"typography\": [string] },\n  \"texts\": [string],\n  \"structure\": [string],\n  \"implementation_notes\": [string]\n}"
                    }
                  }
                },
                {
                  "id": "json-only",
                  "type": "adapter",
                  "input_ref": "spec-gemini-llm",
                  "transform": {
                    "type": "chain",
                    "transforms": [
                      { "type": "custom", "name": "extract_json" },
                      { "type": "validate_schema", "schema": "{\"type\":\"object\",\"required\":[\"component_name\",\"component_type\",\"layout\",\"tokens\",\"texts\",\"structure\",\"implementation_notes\"]}" },
                      { "type": "parse_json" }
                    ]
                  },
                  "on_error": "fail"
                }
              ]
            }
          },
          "fallbacks": [
            {
              "id": "repair-gemini",
              "type": "pipeline",
              "nodes": [
                {
                  "id": "repair-gemini-llm",
                  "type": "tool",
                  "tool": {
                    "name": "gemini",
                    "args": {
                      "model": "gemini-3-pro-preview",
                      "thinking_level": "high",
                      "timeout": 60,
                      "stream": false,
                      "prompt": "Return ONLY valid JSON. No markdown, no extra text.\nIf unknown, use empty string or empty array, but NEVER omit keys.\n\nSUMMARY(JSON):\n{{summary-json}}\n\nRAW_OUTPUT:\n{{spec-gemini-llm}}\n\nOUTPUT JSON (exact keys):\n{\n  \"component_name\": string,\n  \"component_type\": string,\n  \"layout\": { \"type\": string, \"notes\": string },\n  \"tokens\": { \"colors\": [string], \"spacing\": [string], \"typography\": [string] },\n  \"texts\": [string],\n  \"structure\": [string],\n  \"implementation_notes\": [string]\n}"
                    }
                  }
                },
                {
                  "id": "json-only-repair",
                  "type": "adapter",
                  "input_ref": "repair-gemini-llm",
                  "transform": {
                    "type": "chain",
                    "transforms": [
                      { "type": "custom", "name": "extract_json" },
                      { "type": "validate_schema", "schema": "{\"type\":\"object\",\"required\":[\"component_name\",\"component_type\",\"layout\",\"tokens\",\"texts\",\"structure\",\"implementation_notes\"]}" },
                      { "type": "parse_json" }
                    ]
                  },
                  "on_error": "fail"
                }
              ]
            },
            {
              "id": "spec-claude",
              "type": "pipeline",
              "nodes": [
                {
                  "id": "spec-claude-llm",
                  "type": "tool",
                  "tool": {
                    "name": "claude-cli",
                    "args": {
                      "model": "opus",
                      "output_format": "json",
                      "system_prompt": "Return ONLY valid JSON. No extra text.",
                      "timeout": 60,
                      "prompt": "You MUST return a JSON object that matches the exact schema.\nIf unknown, use empty string or empty array, but NEVER omit keys.\n\nSUMMARY(JSON):\n{{summary-json}}\n\nOUTPUT JSON (exact keys):\n{\n  \"component_name\": string,\n  \"component_type\": string,\n  \"layout\": { \"type\": string, \"notes\": string },\n  \"tokens\": { \"colors\": [string], \"spacing\": [string], \"typography\": [string] },\n  \"texts\": [string],\n  \"structure\": [string],\n  \"implementation_notes\": [string]\n}"
                    }
                  }
                },
                {
                  "id": "json-only-claude",
                  "type": "adapter",
                  "input_ref": "spec-claude-llm",
                  "transform": {
                    "type": "chain",
                    "transforms": [
                      { "type": "custom", "name": "extract_json" },
                      { "type": "validate_schema", "schema": "{\"type\":\"object\",\"required\":[\"component_name\",\"component_type\",\"layout\",\"tokens\",\"texts\",\"structure\",\"implementation_notes\"]}" },
                      { "type": "parse_json" }
                    ]
                  },
                  "on_error": "fail"
                }
              ]
            },
            {
              "id": "summary-to-spec",
              "type": "adapter",
              "input_ref": "summary-json",
              "transform": {
                "type": "chain",
                "transforms": [
                  { "type": "custom", "name": "figma_summary_to_spec" },
                  { "type": "parse_json" }
                ]
              },
              "on_error": "fail"
            },
            {
              "id": "empty-json",
              "type": "adapter",
              "input_ref": "summary-json",
              "transform": {
                "type": "chain",
                "transforms": [
                  { "type": "template", "template": "{\"component_name\":\"\",\"component_type\":\"\",\"layout\":{\"type\":\"\",\"notes\":\"\"},\"tokens\":{\"colors\":[],\"spacing\":[],\"typography\":[]},\"texts\":[],\"structure\":[],\"implementation_notes\":[]}" },
                  { "type": "parse_json" }
                ]
              },
              "on_error": "fail"
            }
          ]
        }
      ]
    }
  ],
  "output": "flow",
  "input_schema": {
    "type": "object",
    "properties": {
      "url": {
        "type": "string",
        "description": "Figma node URL (예: https://www.figma.com/design/...?...node-id=2089-10737)"
      }
    },
    "required": ["url"]
  },
  "output_schema": {
    "type": "object",
    "description": "Component spec JSON"
  },
  "metadata": {
    "author": "Chain Engine",
    "tags": ["figma", "component", "spec", "json"],
    "estimated_duration_sec": 30,
    "estimated_cost_usd": 0.02
  }
}
