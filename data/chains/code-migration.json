{
  "id": "code-migration",
  "name": "Code Migration Pipeline",
  "description": "Automated code migration: analyze old code, generate migration plan, transform code, verify equivalence",
  "version": "1.0.0",
  "nodes": [
    {
      "id": "analyze-source",
      "type": "llm",
      "llm": {
        "model": "codex",
        "prompt": "Analyze this source code for migration:\n\nSource Code ({{input.source_lang}}):\n```\n{{input.source_code}}\n```\n\nExtract:\n1. Core functionality and business logic\n2. Dependencies and imports\n3. Data structures used\n4. Side effects (IO, network, state)\n5. Error handling patterns\n\nOutput JSON: {\"functions\": [...], \"dependencies\": [...], \"data_structures\": [...], \"side_effects\": [...], \"complexity_notes\": [...]}"
      },
      "output_key": "source_analysis"
    },
    {
      "id": "identify-patterns",
      "type": "llm",
      "llm": {
        "model": "gemini",
        "prompt": "Identify migration patterns from {{input.source_lang}} to {{input.target_lang}}:\n\nSource Analysis:\n{{source_analysis}}\n\nFor each pattern found, suggest the idiomatic equivalent in {{input.target_lang}}.\n\nOutput JSON: {\"patterns\": [{\"source_pattern\": \"...\", \"target_pattern\": \"...\", \"notes\": \"...\"}]}"
      },
      "depends_on": ["analyze-source"],
      "output_key": "migration_patterns"
    },
    {
      "id": "generate-migration-plan",
      "type": "llm",
      "llm": {
        "model": "claude-cli",
        "prompt": "Create a detailed migration plan:\n\nSource Language: {{input.source_lang}}\nTarget Language: {{input.target_lang}}\n\nSource Analysis:\n{{source_analysis}}\n\nMigration Patterns:\n{{migration_patterns}}\n\nGenerate a step-by-step plan with:\n1. Order of migration (dependency-aware)\n2. Risk assessment per component\n3. Test strategy\n4. Rollback considerations\n\nOutput JSON: {\"steps\": [{\"order\": N, \"component\": \"...\", \"action\": \"...\", \"risk\": \"low|medium|high\", \"test_approach\": \"...\"}], \"estimated_effort\": \"...\", \"blockers\": [...]}"
      },
      "depends_on": ["analyze-source", "identify-patterns"],
      "output_key": "migration_plan"
    },
    {
      "id": "transform-code",
      "type": "llm",
      "llm": {
        "model": "codex",
        "prompt": "Transform the source code from {{input.source_lang}} to {{input.target_lang}}.\n\nSource Code:\n```{{input.source_lang}}\n{{input.source_code}}\n```\n\nMigration Plan:\n{{migration_plan}}\n\nMigration Patterns:\n{{migration_patterns}}\n\nRequirements:\n1. Preserve all functionality\n2. Use idiomatic {{input.target_lang}} patterns\n3. Maintain equivalent error handling\n4. Add comments for non-obvious translations\n\nOutput the complete transformed code."
      },
      "depends_on": ["migration_plan", "migration_patterns"],
      "output_key": "transformed_code"
    },
    {
      "id": "generate-tests",
      "type": "llm",
      "llm": {
        "model": "claude-cli",
        "prompt": "Generate equivalence tests for the migration:\n\nOriginal Code ({{input.source_lang}}):\n```\n{{input.source_code}}\n```\n\nMigrated Code ({{input.target_lang}}):\n```\n{{transformed_code}}\n```\n\nSource Analysis:\n{{source_analysis}}\n\nGenerate tests that verify:\n1. Function outputs match for same inputs\n2. Edge cases behave identically\n3. Error conditions are handled the same\n\nOutput test code in {{input.target_lang}} test framework."
      },
      "depends_on": ["transformed_code", "analyze-source"],
      "output_key": "equivalence_tests"
    },
    {
      "id": "verify-correctness",
      "type": "llm",
      "llm": {
        "model": "gemini",
        "prompt": "Verify the migration correctness:\n\nOriginal ({{input.source_lang}}):\n```\n{{input.source_code}}\n```\n\nMigrated ({{input.target_lang}}):\n```\n{{transformed_code}}\n```\n\nSource Analysis:\n{{source_analysis}}\n\nCheck for:\n1. Missing functionality\n2. Semantic differences\n3. Performance implications\n4. Security considerations\n\nOutput JSON: {\"issues\": [...], \"warnings\": [...], \"verified\": true|false, \"confidence\": 0.0-1.0}"
      },
      "depends_on": ["transformed_code", "analyze-source"],
      "output_key": "verification"
    },
    {
      "id": "final-report",
      "type": "llm",
      "llm": {
        "model": "claude-cli",
        "prompt": "Generate the final migration report:\n\n## Migration Summary\n- Source: {{input.source_lang}}\n- Target: {{input.target_lang}}\n\n## Transformed Code\n```{{input.target_lang}}\n{{transformed_code}}\n```\n\n## Equivalence Tests\n```\n{{equivalence_tests}}\n```\n\n## Verification Results\n{{verification}}\n\n## Migration Plan Reference\n{{migration_plan}}\n\nFormat as a complete migration document with:\n1. Executive Summary\n2. Code (with syntax highlighting hints)\n3. Tests\n4. Known Limitations\n5. Next Steps"
      },
      "depends_on": ["transformed_code", "equivalence_tests", "verification", "migration_plan"],
      "output_key": "migration_report"
    }
  ],
  "output": "final-report",
  "input_schema": {
    "type": "object",
    "properties": {
      "source_code": {
        "type": "string",
        "description": "The source code to migrate"
      },
      "source_lang": {
        "type": "string",
        "description": "Source language (e.g., Python, JavaScript, Java)"
      },
      "target_lang": {
        "type": "string",
        "description": "Target language (e.g., TypeScript, Go, Rust)"
      }
    },
    "required": ["source_code", "source_lang", "target_lang"]
  },
  "metadata": {
    "author": "Chain Engine",
    "tags": ["migration", "refactoring", "code-transform"],
    "estimated_duration_sec": 180,
    "estimated_cost_usd": 0.25
  }
}
